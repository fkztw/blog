<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>  No more requirements-test.txt for Flit or Poetry while using Tox running tests
 | Just for noting</title>

    <meta name="author" content="m157q"/>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/magnific-popup.js/1.1.0/magnific-popup.min.css"/>
    <link rel="stylesheet" href="https://blog.m157q.tw/theme/css/jquery.mglass.css"/>
    <link rel="stylesheet" href="https://blog.m157q.tw/theme/css/pygment-solarized-dark.css"/>
    <link rel="stylesheet" href="https://blog.m157q.tw/theme/css/style.css"/>

    <!-- Fonts -->
    <link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'/>
    <link href='https://fonts.googleapis.com/css?family=Istok+Web' rel='stylesheet' type='text/css'/>
    <link href='https://fonts.googleapis.com/css?family=Droid+Sans+Mono' rel='stylesheet' type='text/css'/>


    <link rel="icon" href="https://blog.m157q.tw/favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="https://blog.m157q.tw/favicon.ico" type="image/x-icon">

    <!-- Feeds -->
      <link href="https://blog.m157q.tw/feeds/all.feed.atom.xml" type="application/atom+xml" rel="alternate" title="Just for noting - All posts - Atom Feed"/>
      <link href="https://blog.m157q.tw/feeds/atom.xml" type="application/atom+xml" rel="alternate" title="Just for noting - Latest posts - Atom Feed"/>
      <link href="https://blog.m157q.tw/feeds/category.note.atom.xml" type="application/atom+xml" rel="alternate" title="Just for noting - Category: Note - Atom Feed"/>

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-45367183-2', 'auto');
    ga('send', 'pageview');
    </script>



  </head>

  <body>

    <div class="container">

      <div class="page-header">
        <h1><a href="https://blog.m157q.tw">Just for noting</a> <small></small></h1>
      </div>

      <nav class="navbar navbar-default">

        <!-- Hamburger menu for mobile -->
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#plumage-navbar-collapse-1" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="https://blog.m157q.tw" title="">Just for noting</a>
        </div>

        <!-- Menus and search forms -->
        <div class="collapse navbar-collapse" id="plumage-navbar-collapse-1">

          <ul class="nav navbar-nav">
<li >
                <a href="/categories">Categories</a>
              </li>
<li >
                <a href="/archives">Archives</a>
              </li>
<li >
                <a href="/tags">Tags</a>
              </li>
          </ul>


            <form class="navbar-form navbar-right" role="search" action="https://blog.m157q.tw/search.html" onsubmit="return validateForm(this.elements['q'].value);">
              <div class="form-group">
                <div class="input-group">
                  <input type="text" name="q" id="tipue_search_input" class="form-control search-query" placeholder="Search" required />
                  <span class="input-group-btn">
                    <button class="btn btn-default" type="submit"><i class="fa
                        fa-search fa-fw"></i></button>
                  </span>
                </div>
              </div>
            </form>

        </div>

      </nav>

    </div>


    <div class="container main">


      <div class="row">
        <div class=" col-md-9  ">
  <h1>
    <a href="https://blog.m157q.tw/posts/2020/07/11/no-more-requirements-test-txt-for-flit-or-poetry-while-using-tox-running-tests/" rel="bookmark" title="Permalink to No more requirements-test.txt for Flit or Poetry while using Tox running tests">No more requirements-test.txt for Flit or Poetry while using Tox running tests</a>
  </h1>
        </div>
      </div>

      <div class="row">


        <div class=" col-md-9 " id="content" role="main">
  

  <blockquote>
    <p>最近開始用 <code>pyproject.toml</code> 取代 <code>setup.py</code>, <code>requirements.txt</code>, ...，紀錄一下遇到的問題。</p>
  </blockquote>
  <div>
    <h1>前言</h1>
<p>目前使用 <code>poetry</code> 和 <code>flit</code> 這兩套工具，皆可以讀取 <code>pyproject.toml</code>。<br>
但 <code>flit</code> 的開發較早，功能也比較陽春一些，如果是剛轉換的話，推薦直接使用 <code>poetry</code>。<br>
兩者最大的差別主要在於 <code>poetry</code> 有 lock dependencies 的機制，但 <code>flit</code> 沒有。</p>
<p>兩者都可以捨棄 requirements.txt files，與 tox 結合進行測試。</p>
<p>而 <code>tox.ini</code> 現在也可以寫在 <code>pyproject.toml</code> 裡頭了，請參考：<a href="https://tox.readthedocs.io/en/latest/example/basic.html#pyproject-toml-tox-legacy-ini">Basic usage — tox 3.16.2.dev1 documentation</a>，所以以下的 <code>tox</code> 相關設定都是以這種方式寫在 <code>pyproject.toml</code> 裡頭。</p>
<h1>Poetry 解法</h1>
<h2>Poetry 官方解法</h2>
<ul>
<li><a href="https://python-poetry.org/docs/faq/#is-tox-supported">FAQ | Documentation | Poetry - Python dependency management and packaging made easy.</a></li>
</ul>
<div class="highlight"><pre><span></span><span class="k">[tox]</span>
<span class="na">isolated_build</span> <span class="o">=</span> <span class="s">true</span>
<span class="na">envlist</span> <span class="o">=</span> <span class="s">py27, py36</span>

<span class="k">[testenv]</span>
<span class="na">whitelist_externals</span> <span class="o">=</span> <span class="s">poetry</span>
<span class="na">commands</span> <span class="o">=</span><span class="s"></span>
<span class="s">    poetry install -v</span>
<span class="s">    poetry run pytest tests/</span>
</pre></div>


<p>將 <code>tox.ini</code> 照著上面的方式修改即可。<br>
可以看到重點是在 <code>whitelist_externals = poetry</code> 這行。<br>
會讓 tox 建立的獨立 virtualenv 可以使用外部的指令。<br>
所以內部的獨立 virtualenv 便有了 <code>poetry</code> 可以用了。（當然前提是外部環境有裝 <code>poetry</code>）  </p>
<p>因為 <code>poetry install</code> 預設會自行偵測現在使用的 virtualenv，所以會正確將套件安裝到每個由 tox 建立出來的獨立 virtualenv 中。（<code>-v</code> 則是詳細顯示出安裝了哪些東西，方便確認是否真的有安裝需要的套件。）</p>
<p>最後就能直接用 <code>poetry run</code> 來跑測試了。</p>
<h2>Poetry 另類解法</h2>
<p><strong>先註明：還是比較推薦上述的官方方法，這個另類解法只是提供另外一種紀錄方式，下面會提到其缺點。</strong></p>
<p>Poetry 有個 <code>export</code> 指令，可以將 lock file 轉為其他格式，目前僅支援 <code>requirements.txt</code> 的格式：<a href="https://python-poetry.org/docs/cli/#export">Commands | Documentation | Poetry - Python dependency management and packaging made easy.</a><br>
這個方法的邏輯很簡單。以前的 <code>requirements-test.txt</code> 是直接存在 repo 裡頭，但現在把它刪除掉，改成每次都透過 <code>poetry export --dev -f requirements.txt &gt; requirements-test.txt</code> 產生 <code>requirements-test.txt</code>。 完全不用修改 <code>tox</code> 相關的設定，用完後再將 <code>requirements-test.txt</code> 刪除即可。<br>
但這個方法有個缺點，可能會安裝過多東西。因為 <code>poetry export</code> 的 <code>--dev</code> 是將開發相關的套件相依全部納入，並沒有生成只和測試相關套件的 <code>requirements-test.txt</code></p>
<h1>Flit 解法</h1>
<p><strong>這個其實才是我這次想解決的問題，因為某個 side project 在我一開始知道 <code>pyproject.toml</code> 後，而 <code>poetry</code> 還沒出來之前，就採用了 <code>flit</code> 進行套件管理。但 flit 的官方網站又沒有提到遇到跟 tox 的整合該如何處理，所以我參考了 <code>poetry</code> 的解法。但因為 <code>flit</code> 和 <code>poetry</code> 的運作機制不太一樣，所以需要做些調整，紀錄在下面。</strong></p>
<ul>
<li>參考 Poetry 官方解法，在 <code>tox.ini</code> 裡頭使用 <code>whitelist_externals</code></li>
<li>但 <code>flit install</code> 不會自動偵測目前所使用的 virtualenv，所以安裝的時候預設會裝在 <code>flit</code> 自帶的 lib 底下，必須安裝在 <code>tox</code> 使用的 virtualenv python lib 底下才有用。</li>
<li>還好 <code>flit install</code> 有 <code>--python</code> 這個選項，只要把 <code>tox</code> 使用的 virtualenv python 路徑給他就行了</li>
<li>然後發現 tox.ini 有內建變數 <code>{envpython}</code> 可以直接拿到 virtualenv python path，就解決了。<ul>
<li><a href="https://tox.readthedocs.io/en/latest/config.html#substitutions-for-virtualenv-related-sections">tox configuration specification — tox 3.16.2.dev1 documentation</a></li>
</ul>
</li>
</ul>
<p>以下是在 <code>pyproject.toml</code> 裡頭修改後的結果：</p>
<div class="highlight"><pre><span></span><span class="err">#</span><span class="w"> </span><span class="n">Tox</span><span class="w"></span>
<span class="o">[</span><span class="n">tool.tox</span><span class="o">]</span><span class="w"></span>
<span class="n">legacy_tox_ini</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">&quot;&quot;&quot;</span>

<span class="ss">[tox]</span>
<span class="ss">isolated_build = True</span>
<span class="ss">skipsdist = true</span>
<span class="ss">envlist = py34,py35,py36,py37,py38</span>

<span class="ss">[testenv]</span>
<span class="ss">whitelist_externals = flit</span>
<span class="ss">commands =</span>
<span class="ss">    flit install --extras test --python {envpython}</span>
<span class="ss">    pytest -vv --flake8 --cov hor2vec/ --cov-report html --cov-report term --junitxml=test-reports/junit.xml --flake8</span>
<span class="ss">&quot;&quot;&quot;</span><span class="w"></span>
</pre></div>


<h1>修改前後的對比</h1>
<p><img alt="Run tox with flit" src="/files/no-more-requirements-test-txt-for-flit-or-poetry-while-using-tox-running-tests/run-tox-with-flit.jpg"></p>
  </div>

    <hr>
    <section>
        <p id="post-share-links">
            <h3>Share</h3>
            <a href="https://twitter.com/intent/tweet?text=No%20more%20requirements-test.txt%20for%20Flit%20or%20Poetry%20while%20using%20Tox%20running%20tests%0Ahttps%3A//blog.m157q.tw/posts/2020/07/11/no-more-requirements-test-txt-for-flit-or-poetry-while-using-tox-running-tests/%0Avia%20%40M157q%0A" target="_blank" title="Share on Twitter"><i class="fa fa-twitter-square fa-3x"></i></a>
            <a href="https://www.facebook.com/sharer/sharer.php?s=100&amp;p%5Burl%5D=https%3A//blog.m157q.tw/posts/2020/07/11/no-more-requirements-test-txt-for-flit-or-poetry-while-using-tox-running-tests/" target="_blank" title="Share on Facebook"><i class="fa fa-facebook-square fa-3x"></i></a>
            <a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A//blog.m157q.tw/posts/2020/07/11/no-more-requirements-test-txt-for-flit-or-poetry-while-using-tox-running-tests/&title=No%20more%20requirements-test.txt%20for%20Flit%20or%20Poetry%20while%20using%20Tox%20running%20tests&summary=%E6%9C%80%E8%BF%91%E9%96%8B%E5%A7%8B%E7%94%A8%20pyproject.toml%20%E5%8F%96%E4%BB%A3%20setup.py%2C%20requirements.txt%2C%20...%EF%BC%8C%E7%B4%80%E9%8C%84%E4%B8%80%E4%B8%8B%E9%81%87%E5%88%B0%E7%9A%84%E5%95%8F%E9%A1%8C%E3%80%82&source=https%3A//blog.m157q.tw/posts/2020/07/11/no-more-requirements-test-txt-for-flit-or-poetry-while-using-tox-running-tests/" target="_blank" title="Share on LinkedIn"><i class="fa fa-linkedin-square fa-3x"></i></a>
            <a href="mailto:?subject=No%20more%20requirements-test.txt%20for%20Flit%20or%20Poetry%20while%20using%20Tox%20running%20tests&amp;body=https%3A//blog.m157q.tw/posts/2020/07/11/no-more-requirements-test-txt-for-flit-or-poetry-while-using-tox-running-tests/" target="_blank" title="Share via Email"><i class="fa fa-envelope-o fa-3x"></i></a>
        </p>
    </section>

<hr>
<section id="donation">
    <h3>Donation</h3>
    <p id="donation-chinese">
      如果覺得這篇文章對你有幫助，
      除了留言讓我知道外，
      或許也可以考慮請我喝杯咖啡，
      不論金額多寡我都會非常感激且能鼓勵我繼續寫出對你有幫助的文章。
    </p>
    <p id="donation-english">
      If this blog post happens to be helpful to you, besides of leaving a reply, you may consider buy me a cup of coffee to support me. It would help me write more articles helpful to you in the future and I would really appreciate it.
    </p>
    <ul id="donation-address">
			<li><a href="https://payment.opay.tw/Broadcaster/Donate/4E163AAE10E448A30DB244CF85527271">歐付寶</a></li>

        <li><a href="https://buymeacoffee.com/M157q">Buy Me a Coffee</a></li>


			<li>BTC: <a href="https://blockchain.info/address/3QZy3cHvoZcszuqWK5CdCutLEJLeAX5ip6">3QZy3cHvoZcszuqWK5CdCutLEJLeAX5ip6</a></li>

			<li>USDT Omni: <a href="https://blockchain.info/address/3QZy3cHvoZcszuqWK5CdCutLEJLeAX5ip6">3QZy3cHvoZcszuqWK5CdCutLEJLeAX5ip6</a></li>

			<li>ETH: <a href="https://etherscan.io/address/0x926bf92b29de4C6E15CbCE99e0a7aB053877181b">0x926bf92b29de4C6E15CbCE99e0a7aB053877181b</a></li>

			<li>USDT ERC20: <a href="https://etherscan.io/address/0x926bf92b29de4C6E15CbCE99e0a7aB053877181b">0x926bf92b29de4C6E15CbCE99e0a7aB053877181b</a></li>

			<li>DAI: <a href="https://etherscan.io/address/0x926bf92b29de4C6E15CbCE99e0a7aB053877181b">0x926bf92b29de4C6E15CbCE99e0a7aB053877181b</a></li>

			<li>LTC: <a href="https://chainz.cryptoid.info/ltc/address.dws?MD26bUR4VsykGp8Ky2QbstejoFGJaj3hpM.htm">MD26bUR4VsykGp8Ky2QbstejoFGJaj3hpM</a></li>
    </ul>
</section>

    <hr>
    <h3>Related Posts</h3>
    <!-- TODO: Use fancier related layout, as in http://kevin.deldycke.com/2012/04/beautify-contextual-related-posts-wordpress-plugin/ -->
    <ul>
        <li><a href="https://blog.m157q.tw/posts/2020/06/09/poetry-pip-pyproject-toml/">Poetry, pip, pyproject.toml</a></li>
        <li><a href="https://blog.m157q.tw/posts/2017/08/27/setuptools-36-2-0-upgrading-downgrading-uninstall-rollback-error-with-python-3-6-2-on-travis-ci/">setuptools 36.2.0 upgrading/downgrading uninstall rollback error with Python 3.6.2 on Travis CI</a></li>
        <li><a href="https://blog.m157q.tw/posts/2018/01/03/try-to-do-gofmt-in-python/">嘗試在 Python 中做到 Golang fmt 的效果</a></li>
        <li><a href="https://blog.m157q.tw/posts/2015/02/04/pip-install-lxml-fail-in-mac/">pip install lxml fail in Mac</a></li>
        <li><a href="https://blog.m157q.tw/posts/2021/12/20/y2021w50/">Y2021W50</a></li>
      </ul>

    <div class="comments">
      <div id="disqus_thread"></div>
	  <script type="text/javascript">
        var disqus_shortname = 'm157q-logdown';
        var disqus_identifier = "posts/2020/07/11/no-more-requirements-test-txt-for-flit-or-poetry-while-using-tox-running-tests/";
        var disqus_title = "No more requirements-test.txt for Flit or Poetry while using Tox running tests";
        var disqus_url = "https://blog.m157q.tw/posts/2020/07/11/no-more-requirements-test-txt-for-flit-or-poetry-while-using-tox-running-tests/";

        var disqus_config = function () {
            this.page.url = disqus_url;
            this.page.identifier = disqus_identifier;
        };
        (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
      </script>
      <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus</a>.</noscript>
    </div>

        </div>

          <div class="col-md-3">
  <div class="well">

    <p><abbr title="2020-07-11T15:54:19+08:00"><i class="fa fa-calendar"></i> Sat 11 July 2020</abbr></p>


      <p><address>
        <i class="fa fa-user"></i> By
          <a href="https://blog.m157q.tw/author/m157q.html" rel="author">m157q</a>
      </address></p>

    <hr/>

      <p>
              <p>
              <a href="https://blog.m157q.tw/category/note/" rel="tag"
                  data-toggle="tooltip"
                  class="label label-info"
                  title="142 articles in this category">Note</a>
              </p>
            <a href="/tag/python/" data-toggle="tooltip"
      class="label label-default"
      title="81 articles with this tag">python</a>
  <br>
            <a href="/tag/poetry/" data-toggle="tooltip"
      class="label label-default"
      title="2 articles with this tag">Poetry</a>
  <br>
            <a href="/tag/setuptools/" data-toggle="tooltip"
      class="label label-default"
      title="2 articles with this tag">setuptools</a>
  <br>
            <a href="/tag/tox/" data-toggle="tooltip"
      class="label label-default"
      title="1 article with this tag">Tox</a>
  <br>
            <a href="/tag/flit/" data-toggle="tooltip"
      class="label label-default"
      title="1 article with this tag">Flit</a>
  <br>
      </p>
      <hr/>


      <nav>
        <ul class="pager">
          <li class="previous ">
            <a  href="https://blog.m157q.tw/posts/2020/06/09/poetry-pip-pyproject-toml/" title="Poetry, pip, pyproject.toml"  rel="prev">
              <span aria-hidden="true">←</span> Older
            </a>
          </li>
          <li class="next ">
            <a  href="https://blog.m157q.tw/posts/2020/07/11/things-that-kubernetes-tutorials-didnt-teach-you/" title="Things that Kubernetes tutorials didn&#39;t teach you"  rel="next">
              Newer <span aria-hidden="true">→</span>
            </a>
          </li>
        </ul>
      </nav>

  </div>
            
          </div>

      </div>

    </div>

    <!-- TODO: make footer sticky -->
    <footer class="container-fluid">
      <div class="container">
        <div class="row">

            <div class="col-md-2">
                <h5>Social</h5>
                <ul class="list-unstyled">
                  <li>  <a href="https://github.com/M157q">
      <i class="fa fa-github"></i>
    GitHub
  </a></li>
                  <li>  <a href="https://twitter.com/M157q">
      <i class="fa fa-twitter"></i>
    Twitter
  </a></li>
                </ul>
            </div>
            <div class="col-md-2">
                <h5>Links</h5>
                <ul class="list-unstyled">
                  <li>  <a href="http://getpelican.com/">
      <img src="https://www.google.com/s2/favicons?domain=getpelican.com" width="16" height="16" class="icon" alt="getpelican.com icon"/>
    Pelican
  </a></li>
                  <li>  <a href="http://python.org/">
      <img src="https://www.google.com/s2/favicons?domain=python.org" width="16" height="16" class="icon" alt="python.org icon"/>
    Python.org
  </a></li>
                  <li>  <a href="http://jinja.pocoo.org/">
      <img src="https://www.google.com/s2/favicons?domain=jinja.pocoo.org" width="16" height="16" class="icon" alt="jinja.pocoo.org icon"/>
    Jinja2
  </a></li>
                </ul>
            </div>

          <div class="col-md-2">
            <h5>Browse content by</h5>
            <ul class="list-unstyled">
                <li><a href="https://blog.m157q.tw/categories/index.html"><i class="fa fa-tags"></i> Categories</a></li>
                <li><a href="https://blog.m157q.tw/archives/index.html"><i class="fa fa-calendar"></i> Dates</a></li>
                <li><a href="https://blog.m157q.tw/tags/index.html"><i class="fa fa-tag"></i> Tags</a></li>
            </ul>
          </div>

          <div class="col-md-2 text-muted">
            <h5>Copyright notice</h5>
            <p>© Copyright 2013-2022 m157q.</p>
          </div>

          <div class="col-md-2 text-muted">
            <h5>Disclaimer</h5>
              <p>All opinions expressed in this site are my own personal opinions and are not endorsed by, nor do they represent the opinions of my previous, current and future employers or any of its affiliates, partners or customers.</p>
          </div>

          <div class="col-md-2">
              <h5>Feeds</h5>
              <ul class="list-unstyled">
                  <li><small><a href="https://blog.m157q.tw/feeds/all.feed.atom.xml"><i class="fa fa-rss"></i> All posts (Atom)</a></small></li>
                  <li><small><a href="https://blog.m157q.tw/feeds/atom.xml"><i class="fa fa-rss"></i> Latest posts (Atom)</a></small></li>
                  <li><small><a href="https://blog.m157q.tw/feeds/category.note.atom.xml"><i class="fa fa-rss"></i> Category: Note (Atom)</a></small></li>
              </ul>
          </div>

        </div>
      </div>

      <h5 class="text-right"><a href="#"><i class="fa fa-arrow-up"></i> Back to top</a></h5>

      <div class="container">
        <div class="row col-md-12 text-muted text-center">
          Site generated by <a href="https://getpelican.com"> Pelican</a>.<br/>
          <a href="https://github.com/kdeldycke/plumage"> Plumage</a> theme by <a href="https://kevin.deldycke.com">Kevin Deldycke</a>.
        </div>
      </div>

    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/magnific-popup.js/1.1.0/jquery.magnific-popup.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fitvids/1.1.0/jquery.fitvids.min.js"></script>
    <script src="https://blog.m157q.tw/theme/js/jquery.mglass.js"></script>
    <script src="https://blog.m157q.tw/theme/js/application.js"></script>

  </body>
</html>